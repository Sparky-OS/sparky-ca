#!/bin/bash
#
# Created by Paweł "pavroo" Pijanowski 2018/02/17
# Copyright 2018 Paweł "pavroo" Pijanowski <pavroo@onet.eu>
# Copyright 2025 Jules <jules@smol.ai>
# Under the GNU GPL v2
# Last update 2025/11/19

# Get default's locale file
DEFLOCDIR="/usr/share/sparky/sparky-ca"
LOCALE=$(cat /etc/default/locale | grep "LANG=" | cut -d'=' -f2 | cut -d'.' -f1)

if [ -f "$DEFLOCDIR/$LOCALE" ]; then
    . "$DEFLOCDIR/$LOCALE"
else
    . "$DEFLOCDIR/en"
fi

testroot=$(whoami)
if [ "$testroot" != "root" ]; then
    echo "$LOCAL_MUST_BE_ROOT"
    exit 1
fi

DIALOG="yad --window-icon=seahorse --width=500 --height=400 --center"
DIALOG4="yad --window-icon=seahorse --width=450 --height=250 --center"
TITLE="--always-print-result --dialog-sep --image=seahorse --title="
TEXT="--text="
MENU="--list --column=$LOCAL1 --column=$LOCAL2"
OKEXIT="--button=Ok:0 --button=$LOCAL3:1"
YESNO="--button=$LOCAL13:0 --button=$LOCAL14:1"
MSGBOX="--button=Ok:0"
TITLETEXT="$LOCAL4"

if [ -f /usr/bin/sparky-xterm ]; then
    SPARKYXTERM="/usr/bin/sparky-xterm"
else
    echo "$LOCAL_SPARKY_XTERM_MISSING"
    exit 1
fi

CADIR="/usr/local/share/ca-certificates"
CABRDIR="ICP-Brazil"
if [ ! -d "$CADIR/$CABRDIR" ]; then
    mkdir -p "$CADIR/$CABRDIR"
fi
cd "$CADIR/$CABRDIR"

# Brazilian certificates servers
BRSERVER="https://acraiz.icpbrasil.gov.br/credenciadas/RAIZ"

# Brazilian certificates names
CERTIFICATES=(
    "ICP-Brasilv2.crt"
    "ICP-Brasilv4.crt"
    "ICP-Brasilv5.crt"
    "ICP-Brasilv6.crt"
    "ICP-Brasilv7.crt"
    "ICP-Brasilv10.crt"
    "ICP-Brasilv11.crt"
    "ICP-Brasilv12.crt"
    "ICP-Brasilv13.crt"
)

#
# Downloads and installs a single certificate.
#
download_certificate() {
    local cert_name=$1
    if [ -f "$cert_name" ]; then
        $DIALOG4 $TITLE"$TITLETEXT" $YESNO $TEXT"\n$cert_name $LOCAL11\n$LOCAL12"
        if [ "$?" = "0" ]; then
            rm -f "$cert_name"
            $SPARKYXTERM "wget $BRSERVER/$cert_name"
        fi
    else
        $SPARKYXTERM "wget $BRSERVER/$cert_name"
    fi
}

#
# Displays the main menu of the application and calls the appropriate
# function based on user selection.
#
mainmenu() {
    local menu_options=()
    for cert in "${CERTIFICATES[@]}"; do
        menu_options+=("$cert" "$cert")
    done
    menu_options+=("All" "$LOCAL_ALL_CERTIFICATES")
    menu_options+=("Exit" "$LOCAL3")

    CHOICES=$($DIALOG $TITLE"$TITLETEXT" $MENU $OKEXIT $TEXT"$LOCAL5:" "${menu_options[@]}")

    if [ "$?" = "0" ]; then
        CHOICE=$(echo "$CHOICES" | cut -d "|" -f 1)
    else
        exit 0
    fi

    if [ "$CHOICE" = "All" ]; then
        download_all_certificates
    elif [ "$CHOICE" = "Exit" ]; then
        exit 0
    else
        download_certificate "$CHOICE"
        $SPARKYXTERM "update-ca-certificates"
        local downloaded_certs=""
        if [ -f "$CHOICE" ]; then
            downloaded_certs="$CHOICE"
        fi
        $DIALOG4 $TITLE"$TITLETEXT" $MSGBOX $TEXT"\n$LOCAL15\n$downloaded_certs"
        mainmenu
    fi
}

#
# Downloads and installs all certificates.
#
download_all_certificates() {
    for cert in "${CERTIFICATES[@]}"; do
        download_certificate "$cert"
    done
    $SPARKYXTERM "update-ca-certificates"
    local downloaded_certs=""
    for cert in "${CERTIFICATES[@]}"; do
        if [ -f "$cert" ]; then
            downloaded_certs+="$cert\n"
        fi
    done
    $DIALOG4 $TITLE"$TITLETEXT" $MSGBOX $TEXT"\n$LOCAL15\n$downloaded_certs"
    mainmenu
}

mainmenu

exit 0
